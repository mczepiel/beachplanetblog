var Montage=require("montage").Montage,Node=require("runtime/node").Node,RuntimeTFLoader=require("runtime/runtime-tf-loader").RuntimeTFLoader,URL=require("montage/core/url"),SceneResourceLoader=require("runtime/scene-resource-loader").SceneResourceLoader,Q=require("q"),Target=require("montage/core/target").Target;exports.Scene=Target.specialize({constructor:{value:function(){this.super()}},_resourcesLoaded:{value:!1,writable:!0},_glTFElement:{value:null,writable:!0},_rootNode:{value:null,writable:!0},rootNode:{get:function(){return"loaded"===this.status&&null==this._rootNode&&(this._rootNode=Montage.create(Node),this._rootNode.scene=this,this._rootNode.id=this.glTFElement.rootNode.id),this._rootNode}},sceneResourcesDidPrepare:{value:function(){this._resourcesLoaded||(this._prepareToRenderDefer&&this._prepareToRenderDefer.resolve(),this._resourcesLoaded=!0,this.dispatchEventNamed("resourcesDidLoad",!0,!1,this),this.status="loaded")}},isLoaded:{value:function(){return"loaded"==this.status}},status:{value:0,writable:!0},styleSheetsLoaded:{value:!1,writable:!0},styleSheets:{value:null,writable:!0},loadCSSStyles:{value:function(){if(null!=document.styleSheets){var e,t,n=Object.keys(require.packages),i=0,r=document.styleSheets.length,a=[];for(this.styleSheets={},e=0;r>e;e++)t=document.styleSheets[e],null!=t.href&&-1!=t.href.indexOf(n[0])&&-1==t.href.indexOf(n[0]+"node_modules")&&a.push(t);return r=a.length,0===r?(this.styleSheetsLoaded=!0,void 0):(a.forEach(function(e){var t=this,n=e.href,a=new XMLHttpRequest;a.open("GET",n,!0),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var n=CSSOM.parse(a.responseText);t.styleSheets[e.href]=n,i++,i===r&&t.dispatchEventNamed("styleSheetsDidLoad",!0,!1,t)}},a.send(null)},this),!1)}}},path:{set:function(e){if(e){if(-1===e.indexOf(".json"))return;var t=URL.parse(e);if(!t.scheme){var n=Object.keys(require.packages);e=URL.resolve(n[0],e)}}if(e!==this._path){var i={};if(i.loadCompleted=function(e){this.totalBufferSize=r.totalBufferSize,this.glTFElement=e,this.status="loaded",console.log("scene loaded:"+this._path)}.bind(this),e){var r=Object.create(RuntimeTFLoader);this.status="loading",r.initWithPath(e),r.delegate=i,r.load(null,null)}else this.scene=null;this._path=e}},get:function(){return this._path}},_prepareToRenderDefer:{value:null,writable:!0},prepareToRender:{value:function(e){if(null==this._prepareToRenderDefer){this._prepareToRenderDefer=Q.defer();var t=Object.create(SceneResourceLoader).init(this.glTFElement,e,this);t.loadScene()}return this._prepareToRenderDefer.promise}},init:{value:function(e){return e&&(this.glTFElement=e,this.status="loaded"),this}}});