require("runtime/dependencies/gl-matrix");var Base=require("runtime/base").Base,Transform=require("runtime/transform").Transform,Utilities=require("runtime/utilities").Utilities;exports.Skin=Object.create(Object.prototype,{jointsIds:{value:null,writable:!0},nodesForSkeleton:{value:null,writable:!0},bindShapeMatrix:{value:null,writable:!0},inverseBindMatricesDescription:{value:null,writable:!0},matricesForSkeleton:{value:null,writable:!0},sources:{value:null,writable:!0},init:{value:function(){return this.jointsIds=[],this.nodesForSkeleton={},this.matricesForSkeleton={},this.sources=[],this}},inverseBindMatricesDelegate:{value:{handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t){return new Float32Array(t)},resourceAvailable:function(){}}},process:{value:function(e,t){var n=Object.keys(this.nodesForSkeleton),i=mat4.create();mat4.inverse(e.worldMatrix,i),n.forEach(function(e){var n=this.nodesForSkeleton[e],r=this.matricesForSkeleton[e];if(!r){var s=16*this.jointsIds.length;r=new Float32Array(s),this.matricesForSkeleton[e]=r;for(var a=mat4.identity(),o=0;s>o;o++)r[o]=a[o%16]}var l=t.getResource(this.inverseBindMatricesDescription,this.inverseBindMatricesDelegate);l&&this.sources.forEach(function(e){for(var t=e,s=this.bindShapeMatrix,a=this.jointsIds.length,o=mat4.create(),u=0;a>u;u++){for(var h=0;16>h;h++)o[h]=l[16*u+h];var c=n[u].worldMatrix,d=mat4.identity();mat4.multiply(d,i),mat4.multiply(d,c),mat4.multiply(d,o),mat4.multiply(d,s);for(var h=0;16>h;h++)r[16*u+h]=d[h]}t.primitives.forEach(function(e){e.material.parameters&&(e.material.parameters.jointMat.value=r)},this)},this)},this)}}});