montageDefine("bfd16e7","core/localizer",{dependencies:["montage","core/messageformat","core/logger","core/serialization","core/promise","core/bindings","collections/listen/property-changes","frb/bindings","frb/stringify","frb/expand","frb/scope","core/messageformat-locale"],factory:function(e,t){var n=e("montage").Montage,i=e("core/messageformat"),r=e("core/logger").logger("localizer"),a=e("core/serialization").Serializer,s=e("core/serialization").Deserializer,o=e("core/promise").Promise,l=e("core/bindings").Bindings,u=(e("collections/listen/property-changes"),e("frb/bindings")),c=e("frb/stringify"),h=e("frb/expand"),d=e("frb/scope");i.locale=e("core/messageformat-locale");var m="key",p="default",f="montage_locale",v="locale",_="messages",g="manifest.json",y=function(){return""},b=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,C=t.Localizer=n.specialize({constructor:{value:function C(){this.super()}},init:{value:function(e){return this.locale=e||S.locale,this}},initWithMessages:{value:function(e,t){return this.locale=e,this.messages=t,this}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(e){if(this._messages!==e){if(null!=e&&"object"!=typeof e)throw new TypeError(e," is not an object");this._messages=e}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(e){if(!b.test(e))throw new TypeError("Language tag '"+e+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");this._locale!==e&&(this._locale=e,this.messageFormat=new i(e))}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this._manifest.get("files").get(v).get("files").then(function(e){return Object.keys(e)})}},_require:{value:"undefined"!=typeof global?global.require:"undefined"!=typeof window?window.require:null},require:{serializable:!1,get:function(){return this._require},set:function(e){this._require!==e&&(this.__manifest=null,this._require=e)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var e=this.require;return e.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=e.async(g):o.reject(Error("Package has no manifest. "+e.location+'package.json must contain "manifest": true and '+e.location+g+" must exist"))}},loadMessages:{value:function(e,t){if(!this.require)throw Error("Cannot load messages as",this,"require is not set");null===e&&(e=5e3),this.messages=null;var n=this;this.require;var i=this._manifest;return e&&(i=i.timeout(e)),this.messagesPromise=i.get("files").then(function(e){return n._loadMessageFiles(e)}).then(function(e){return n._collapseMessages(e)}).fail(function(e){throw console.error("Could not load messages for '"+n.locale+"': "+e),e}).then(function(e){return"function"==typeof t&&t(e),e})}},_loadMessageFiles:{value:function(e){var t=this.require;if(!e)return o.reject(Error(t.location+g+" does not contain a 'files' property"));var n,i,a,s,l=[];if(!(v in e))return o.reject(Error("Package does not contain a '"+v+"' directory"));for(n=e[v].files,i=this._locale;""!==i;)n.hasOwnProperty(i)&&(a=n[i].files,(s=_+".js")in a||(s=_+".json")in a?l.push(t.async(v+"/"+i+"/"+s)):r.isDebug&&r.debug(this,"Warning: '"+v+"/"+i+"/' does not contain '"+_+".json' or '"+_+".js'")),i=i.substring(0,i.lastIndexOf("-"));if(!l.length)return o.reject(Error("Could not find any "+_+".json or "+_+".js files"));var u=o.all(l);if(r.isDebug){var c=this;u=u.then(function(e){return r.debug(c,"loaded "+e.length+" message files"),e})}return u}},_collapseMessages:{value:function(e){for(var t={},n=0,i=e.length;i>n;n++){var r=e[n];for(var a in r)a in t||(t[a]=r[a])}return this.messages=t,t}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(e,t){var n,r,a;if(!e&&!t)throw Error("Key or default message must be truthy, not "+e+" and "+t);if(this._messages&&e in this._messages){if(n=this._messages[e],r=typeof n,"function"===r)return n;if("object"===r){if(!("message"in n))throw Error(n,"does not contain a 'message' property");n=n.message}}else n=t;if(n||(console.warn("No message or default message for key '"+e+"'"),n=e),n in this._compiledMessageCache)return this._compiledMessageCache[n];var s=this.messageFormat.parse(n);return s.program&&s.program.statements&&1===s.program.statements.length&&"string"===s.program.statements[0].type?(a=function(){return n},a.toString=a):a=Function("MessageFormat","return "+this.messageFormat.precompile(s))(i),this._compiledMessageCache[n]=a,a}},localize:{value:function(e,t,n,i){var r,a=this;if(n=n===void 0?!0:n,!this.messagesPromise)return r=o.resolve(this.localizeSync(e,t)),r.then(i),r;var s=function(){var n=a.localizeSync(e,t);return"function"==typeof i&&i(n),n};return n?this.messagesPromise.then(s,s):this.messagesPromise.then(s)}}}),E=C.specialize({init:{value:function(){var e=this.callDelegateMethod("getDefaultLocale");return e||"undefined"==typeof window||(window.localStorage&&(e=window.localStorage.getItem(f)),e=e||window.navigator.userLanguage||window.navigator.language),e=e||"en",this.locale=e,this.loadMessages().done(),this}},_delegate:{value:null},delegate:{get:function(){return this._delegate},set:function(e){this._delegate!==e&&(this._delegate=e,this.init())}},locale:{get:function(){return this._locale},set:function(e){try{Object.getPropertyDescriptor(C,"locale").set.call(this,e)}catch(t){e="en",Object.getPropertyDescriptor(C,"locale").set.call(this,e)}"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem(f,e)}},reset:{value:function(){return"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(f),this.init(),this._locale}}}),S=t.defaultLocalizer=(new E).init();t.localize=S.localize.bind(S);var T=t.Message=n.specialize({constructor:{value:function(){this.defineBinding("_data",{"<-":"_dataObject.toMap()"}),this._data.addMapChangeListener(this,"data")}},init:{value:function(e,t,n){return e&&(this.key=e),t&&(this.defaultMessage=t),n&&(this.data=n),this}},_localizer:{value:S},localizer:{get:function(){return this._localizer},set:function(e){this._localizer!=e&&(this._localizer=e,this._localize())}},_key:{value:null},key:{get:function(){return this._key},set:function(e){this._key!==e&&(this._key=e,this._localize())}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(e){this._defaultMessage!==e&&(this._defaultMessage=e,this._localize())}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(!this._isLocalizeQueued){this._isLocalizeQueued=!0;var e=this,t=o.defer();this._messageFunction=t.promise,this.localized=this._messageFunction.then(function(t){return t(e._data.toObject())}),o.nextTick(function(){return e._isLocalizeQueued=!1,e._key||e._defaultMessage?(t.resolve(e._localizer.localize(e._key,e._defaultMessage)),void 0):(console.warn("Both key and default message are falsey for",e,"If this is in a repetition this warning can be ignored"),t.resolve(y),void 0)})}}},_messageFunction:{value:o.resolve(y)},_dataObject:{value:null},_data:{value:null},data:{get:function(){return this._data},set:function(e){this._dataObject!==e&&(this._dataObject=e)}},__localizedResolved:{value:""},_localizedDeferred:{value:o.defer()},localized:{get:function(){return this._localizedDeferred.promise},set:function(e){if(e!==this._localized){var t=this,n=o.defer();this._localizedDeferred.resolve(n.promise),e.then(n.resolve,n.reject),n.promise.then(function(e){return t.__localizedResolved=e}).done(),this._localizedDeferred=n}}},handleDataMapChange:{value:function(){this.localized=this._messageFunction.fcall(this._data.toObject())}},serializeSelf:{value:function(){var e={_bindingDescriptors:this._bindingDescriptors};return e.key=this._key,e.defaultMessage=this._defaultMessage,this._localizer!==S&&(e.localizer=this._localizer),e}},serializeForLocalizations:{value:function(e){var t,n,i={};n=u.getBindings(this),n&&n.key?(i[m]={},this._serializeBinding(this,i[m],n.key,e)):i[m]=this._key,n&&n.defaultMessage?(i[p]={},this._serializeBinding(this,i[p],n.defaultMessage,e)):i[p]=this._defaultMessage;var r=u.getBindings(this._data);t=this._data.toObject();for(var a in t)!t.hasOwnProperty(a)||r&&r[".get('"+a+"')"]||(i.data||(i.data={}),i.data[a]=t[a]);for(var s in r){var o=/\.get\('([^']+)'\)/.exec(s)[1];i.data||(i.data={}),i.data[o]={},this._serializeBinding(this._data,i.data[o],r[s],e)}return i}},_serializeBinding:{value:function(e,t,n,i){if(!("serializable"in n)||n.serializable){var r=n.sourceSyntax;if(n.source!==e){var a=i.addObjectReference(n.source),s=new d({type:"component",label:a["@"]});s.components=i,r=h(r,s)}var s=new d;s.components=i;var o=c(r,s);n.twoWay?t["<->"]=o:t["<-"]=o,n.converter?t.converter=n.converter:(t.convert=n.convert,t.revert=n.revert),n.trace&&(t.trace=!0)}}}}),w=function(e,t,n,i,r,a){var s=new T;for(var o in r)"string"==typeof r[o]?s.data.set(o,r[o]):l.defineBinding(s.data,".get('"+o+"')",r[o],{components:a});"object"==typeof n?l.defineBinding(s,"key",n,{components:a}):s.key=n,"object"==typeof i?l.defineBinding(s,"defaultMessage",i,{components:a}):s.defaultMessage=i,l.defineBinding(e,t,{"<-":"__localizedResolved",source:s,serializable:!1})};a.defineSerializationUnit("localizations",function(e,t){var n=u.getBindings(t);if(n){var i;for(var r in n){var a=n[r];if(T.prototype.isPrototypeOf(a.source)){i||(i={});var s=a.source;i[r]=s.serializeForLocalizations(e)}}return i}}),s.defineDeserializationUnit("localizations",function(e,t,n){for(var i in n){var a,s,o=n[i];m in o?(!r.isDebug||p in o||r.debug(this,"Warning: localized property '"+i+"' does not contain a default message property ("+p+"), in ",t),a=o[m],s=o[p],w(t,i,a,s,o.data,e)):console.error("localized property '"+i+"' must contain a key property ("+m+"), in ",n[i])}})}});