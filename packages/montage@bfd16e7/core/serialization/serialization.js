var Montage=require("core/core").Montage,MontageLabeler=require("./serializer/montage-labeler").MontageLabeler,MontageReviver=require("./deserializer/montage-reviver").MontageReviver,parse=require("frb/parse"),stringify=require("frb/stringify"),Serialization=Montage.specialize({_serializationString:{value:null},_serializationObject:{value:null},initWithString:{value:function(e){return this._serializationString=e,this._serializationObject=null,this}},initWithObject:{value:function(e){return this._serializationString=null,this._serializationObject=e,this}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var e=this.getSerializationObject();return Object.keys(e)}},getExternalObjectLabels:{value:function(){var e=this.getSerializationObject(),t=[];for(var n in e)0===Object.keys(e[n]).length&&t.push(n);return t}},isExternalObject:{value:function(e){var t=this.getSerializationObject();return t&&e in t?0===Object.keys(t[e]).length:!1}},getSerializationLabelsWithElements:{value:function(e){var t=new SerializationInspector,n=[];return t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&e.indexOf(t.data)>=0&&(t=t.parent,t&&"properties"===t.name&&(t=t.parent,t&&"montageObject"===t.type&&n.push(t.label)))}),n}},renameElementReferences:{value:function(e){var t=new SerializationInspector;t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&t.data in e&&(t.data=e[t.data])})}},renameSerializationLabels:{value:function(e){var t=new SerializationInspector;t.initWithSerialization(this),t.visitSerialization(function(t){if(t.label){var n=t.label;n in e&&(t.label=e[n])}if("reference"===t.type){var i=t.data;i in e&&(t.data=e[i])}})}},mergeSerialization:{value:function(e){return SerializationMerger.mergeSerializations(this,e)}},extractSerialization:{value:function(e,t){var n=new SerializationExtractor;return n.initWithSerialization(this),n.extractSerialization(e,t)}}}),SerializationMerger=Montage.specialize(null,{mergeSerializations:{value:function(e,t){var n,i,r,a,o,s;a=e.getSerializationLabels(),o=t.getSerializationLabels(),s=this._createCollisionTable(a,o),s&&(r=t.getSerializationString(),t=(new Serialization).initWithString(r),t.renameSerializationLabels(s),o=t.getSerializationLabels()),n=e.getSerializationObject(),i=t.getSerializationObject();for(var l,u=0;l=o[u];u++)n[l]=i[l];return e.initWithObject(n),s}},_createCollisionTable:{value:function(e,t){for(var n=new MontageLabeler,i={},r=!1,a=0;e.length>a;a++)n.setObjectLabel(null,e[a]);for(var o,a=0;o=t[a];a++)e.indexOf(o)>=0&&(i[o]=n.generateObjectLabel({}),r=!0);return r?i:void 0}}}),SerializationInspector=Montage.specialize({initWithSerialization:{value:function(e){this._serialization=e}},visitSerialization:{value:function(e){var t=this._serialization.getSerializationObject();this._walkRootObjects(e,t),this._serialization.initWithObject(t)}},visitSerializationObject:{value:function(e,t){var n=this._serialization.getSerializationObject();if(!(e in n))throw Error('Object "'+e+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(t,n,e),this._serialization.initWithObject(n)}},changeLabel:{value:function(e,t){var n,i=this._serialization.getSerializationObject();n=i[e],delete i[e],i[t]=n}},_walkRootObjects:{value:function(e,t){for(var n in t)this._walkRootObject(e,t,n)}},_walkRootObject:{value:function(e,t,n){var i=t[n];"value"in i?this._walkObject(e,i,"value",n):this._walkCustomObject(e,t,n)}},_walkObject:{value:function(e,t,n,i,r){var a,o=t[n],s=MontageReviver.getTypeOf(o);if(a={type:s},i?a.label=i:a.name=n,r&&(a.parent=r),"number"===s||"string"===s||"null"===s)a.data=o,e(a),t[n]=a.data;else if("regexp"===s)a.data=o["/"],e(a),o["/"]=a.data;else if("reference"===s)a.data=o["@"],e(a),o["@"]=a.data;else if("Element"===s)a.data=o["#"],e(a),o["#"]=a.data;else if("array"===s){a.data=o,e(a),t[n]=o=a.data;for(var l=0,u=o.length;u>l;l++)this._walkObject(e,o,""+l,null,a)}else if("object"===s){a.data=o,e(a),t[n]=o=a.data;for(var n in o)this._walkObject(e,o,n,null,a)}a.label!=i&&this.changeLabel(i,a.label)}},_walkCustomObject:{value:function(e,t,n){var i,r=t[n];i={type:"montageObject",label:n,data:r},e(i),t[n]=r=i.data,i.label!=n&&this.changeLabel(n,i.label),r.properties&&this._walkObject(e,r,"properties",null,i),r.listeners&&this._walkObject(e,r,"listeners",null,i),r.bindings&&this._walkBindings(e,r,null,i),r.localizations&&this._walkLocalizations(e,r,null,i)}},_walkBindings:{value:function(e,t,n){var i,r=t.bindings;i={type:"bindings",data:r,parent:n},e(i),t.bindings=r=i.data;for(var a in r)this._walkBinding(e,r,a,i)}},_walkBinding:{value:function(e,t,n,i){var r,a=t[n];r={type:"binding",name:n,data:a,parent:i},e(r),t[n]=a=r.data,this._walkBindingData(e,a,r)}},_walkBindingData:{value:function(e,t,n){var i,r,a=!1;i=t["<-"]||t["<->"],r=parse(i),this._walksBindingReferences(r,function(t){var n={type:"reference",data:t.label};e(n),t.label!==n.data&&(t.label=n.data,a=!0)}),a&&("<-"in t?t["<-"]=stringify(r):t["<->"]=stringify(r)),t.converter&&this._walkObject(e,t,"converter",null,n)}},_walkLocalizations:{value:function(e,t,n){var i,r=t.localizations;i={type:"localizations",data:r,parent:n},e(i),t.localizations=r=i.data;for(var a in r)this._walkLocalization(e,r,a,i)}},_walkLocalization:{value:function(e,t,n,i){var r,a,o=t[n];if(r={type:"localization",name:n,data:o,parent:i},e(r),t[n]=o=r.data,"object"==typeof o.key&&this._walkBindingData(e,o.key,r),"object"==typeof o.default&&this._walkBindingData(e,o.default,r),"object"==typeof o.data){a=o.data;for(var n in a)this._walkBindingData(e,a[n],r)}}},_walksBindingReferences:{value:function(e,t){var n=e.args;if("component"===e.type&&t(e),n)for(var i=0,r=n.length;r>i;i++)this._walksBindingReferences(n[i],t)}}}),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(e){this._serialization=e}},extractSerialization:{value:function(e,t){var n,i=new SerializationInspector,r={},a=[];n=this._serialization.getSerializationObject(),i.initWithSerialization(this._serialization);for(var o,s=0;o=e[s];s++)r[o]=n[o],i.visitSerializationObject(o,function(t){var n;"reference"===t.type&&(n=t.data,-1===a.indexOf(n)&&-1===e.indexOf(n)&&a.push(n))});if(t)for(var o,s=0;o=t[s];s++)o in n&&!(o in r)&&(r[o]={});for(var o,s=0;o=a[s];s++)r[o]={};return(new Serialization).initWithObject(r)}}});exports.Serialization=Serialization,exports.SerializationMerger=SerializationMerger,exports.SerializationInspector=SerializationInspector,exports.SerializationExtractor=SerializationExtractor;