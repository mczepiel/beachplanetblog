montageDefine("bfd16e7","core/serialization/deserializer/montage-reviver",{dependencies:["core/core","mousse/deserialization/reviver","./properties-deserializer","./self-deserializer","./unit-deserializer","core/module-reference","core/promise"],factory:function(e,t){var n=e("core/core").Montage,i=e("mousse/deserialization/reviver").Reviver,r=e("./properties-deserializer").PropertiesDeserializer,a=e("./self-deserializer").SelfDeserializer,s=e("./unit-deserializer").UnitDeserializer,o=e("core/module-reference").ModuleReference,l=e("core/promise").Promise,u=n.specialize({_require:{value:null},_objectRequires:{value:null},init:{value:function(e,t){if("function"!=typeof e)throw Error("Function 'require' missing.");if("string"!=typeof e.location)throw Error("Function 'require' location is missing");if("object"!=typeof t&&t!==void 0)throw Error("Parameter 'objectRequires' should be an object.");return this._require=e,this._objectRequires=t,this}},getExports:{value:function(e,t){var n;for(t=e.resolve(t),n=e.getModuleDescriptor(t);void 0!==n.redirect;)n=e.getModuleDescriptor(n.redirect);return void 0!==n.mappingRedirect?this.getExports(n.mappingRequire,n.mappingRedirect):n.exports}},getModule:{value:function(e,t){var n,i,r=this._objectRequires;return n=r&&t in r?r[t]:this._require,i=this.getExports(n,e),i||(i=n.async(e)),i}}}),c=t.MontageReviver=n.specialize.call(i,{moduleLoader:{value:null},init:{value:function(e,t){return this.moduleLoader=(new u).init(e,t),this}},getTypeOf:{value:function(e){if(null!==e&&"object"==typeof e&&1===Object.keys(e).length){if("#"in e)return"Element";if("%"in e)return"Module"}return i.prototype.getTypeOf.call(this,e)}},reviveElement:{value:function(e,t,n){var i=e["#"],r=t.getElementById(i);return r?(n&&t.setObjectLabel(r,n),r):l.reject(Error("Element with id '"+i+"' was not found."))}},reviveModule:{value:function(e,t){var n=e["%"],i=t.getRequire();n=i.resolve(n);var r=i.getModuleDescriptor(n);return(new o).initWithIdAndRequire(r.id,r.require)}},reviveCustomObject:{value:function(e,t,n){return this.reviveMontageObject(e,t,n)}},reviveMontageObject:{value:function(e,t,n){var i,r,a,s=this,o=e.prototype||e.object;return o&&(r=c.parseObjectLocationId(o),i=this.moduleLoader.getModule(r.moduleId,n),a=r.objectName),l.isPromise(i)?i.then(function(i){return s.instantiateMontageObject(e,i,a,t,n)},function(t){throw t.stack&&console.error(t.stack),Error('Error deserializing "'+n+'" when loading module "'+r.moduleId+"' from '"+e.prototype+"'")}):this.instantiateMontageObject(e,i,a,t,n)}},instantiateMontageObject:{value:function(e,t,n,i,r){var a,s,o=this;return a=this.getMontageObject(e,t,n,i,r),i.setObjectLabel(a,r),a.isDeserializing=!0,s=this.reviveObjectLiteral(e,i),l.isPromise(s)?s.then(function(e){return o.deserializeMontageObject(e,a,i,r)}):this.deserializeMontageObject(s,a,i,r)}},deserializeMontageObject:{value:function(e,t,n,i){var r;return"function"==typeof t.deserializeSelf?this.deserializeCustomMontageObject(t,e,n,i):(n.setUnitsToDeserialize(t,e,c._unitNames),r=this.deserializeMontageObjectProperties(t,e.properties,n),l.isPromise(r)?r.then(function(){return t}):t)}},deserializeMontageObjectProperties:{value:function(e,t,n){var i;if("function"==typeof e.deserializeProperties){var a=(new r).initWithReviverAndObjects(this,n);i=e.deserializeProperties(a)}else for(var s in t)e[s]=t[s];return i}},deserializeCustomMontageObject:{value:function(e,t,n,i){var r,s=(new a).initWithObjectAndObjectDescriptorAndContextAndUnitNames(e,t,n,c._unitNames);return r=e.deserializeSelf(s),l.isPromise(r)?r.then(function(e){return n.setObjectLabel(e,i),e}):r!==void 0?(n.setObjectLabel(r,i),r):e}},getMontageObject:{value:function(e,t,n,i,r){var a;if(i.hasUserObject(r))return i.getUserObject(r);if("prototype"in e){if(!(n in t))throw Error('Error deserializing "'+r+'": object named "'+n+'"'+' was not found in "'+e.prototype+'".'+" Available objects are: "+Object.keys(t)+".");return a=Object.create(t[n].prototype),a.isDeserializing=!0,"function"==typeof a.didCreate?a.didCreate():"function"==typeof a.constructor&&a.constructor(),a}if("object"in e){if(!(n in t))throw Error('Error deserializing "'+r+'": object named "'+a+"' was not found given '"+e.object+"'");return t[n]}throw Error("Error deserializing "+JSON.stringify(e)+', might need "prototype" or "object" on label '+JSON.stringify(r))}},didReviveObjects:{value:function(e,t){var n,i=this;return n=this._deserializeUnits(t),l.isPromise(n)?n.then(function(){i._invokeDeserializedFromSerialization(e,t)}):(this._invokeDeserializedFromSerialization(e,t),void 0)}},_invokeDeserializedFromSerialization:{value:function(e,t){var n;for(var i in e)n=e[i],null!=n&&delete n.isDeserializing,t.hasUserObject(i)||n&&"function"==typeof n.deserializedFromSerialization&&n.deserializedFromSerialization(i)}},_deserializeUnits:{value:function(e){for(var t,n,i,r=e.getUnitsToDeserialize(),a=c._unitRevivers,o=0;i=r[o];o++){t=i.unitNames;for(var l,u=0;l=t[u];u++)l in i.objectDesc&&(n=(new s).initWithContext(e),a[l](n,i.object,i.objectDesc[l]))}}}},{_unitRevivers:{value:Object.create(null)},_unitNames:{value:[]},_findObjectNameRegExp:{value:/([^\/]+?)(\.reel)?$/},_toCamelCaseRegExp:{value:/(?:^|-)([^-])/g},_replaceToCamelCase:{value:function(e,t){return t.toUpperCase()}},_locationDescCache:{value:Object.create(null)},parseObjectLocationId:{value:function(e){var t,n,i,r,a=this._locationDescCache;return e in a?t=a[e]:(n=e.indexOf("["),n>0?(i=e.substr(0,n),r=e.slice(n+1,-1)):(i=e,this._findObjectNameRegExp.test(e),r=RegExp.$1.replace(this._toCamelCaseRegExp,this._replaceToCamelCase)),t={moduleId:i,objectName:r},a[e]=t),t}},defineUnitReviver:{value:function(e,t){this._unitRevivers[e]=t,this._unitNames.push(e)}},getTypeOf:{value:function(e){return this.prototype.getTypeOf.call(this,e)}}});t!==void 0&&(t.MontageReviver=c)}});