var Montage=require("core/core").Montage,Target=require("core/target").Target,MontageWindow=require("window-loader/montage-window").MontageWindow,Slot;require("core/dom");var Application=exports.Application=Target.specialize({eventManager:{value:null},parentApplication:{value:null},mainApplication:{get:function(){for(var e=this;e.parentApplication;)e=e.parentApplication;return e}},_windowsSortOrder:{value:"reverse-z-order"},windowsSortOrder:{get:function(){return null==this.parentApplication?this._windowsSortOrder:this.mainApplication.windowsSortOrder},set:function(e){null==this.parentApplication?-1!==["z-order","reverse-z-order","z-order","reverse-open-order"].indexOf(e)&&(this._windowsSortOrder=e):this.mainApplication.windowsSortOrder=e}},windows:{get:function(){var e;if(null==this.parentApplication){if(!this._windows){var e=new MontageWindow;e.application=this,e.window=window,this.window=e,this._windows=[this.window],this._multipleWindow=!0}return this._windows}return this.mainApplication.windows}},_window:{value:null},window:{get:function(){if(!this._window&&this==this.mainApplication){var e=new MontageWindow;e.application=this,e.window=window,this._window=e}return this._window},set:function(e){this._window||(this._window=e)}},attachedWindows:{value:[]},eventManagerForWindow:{value:function(e){return e.defaultEventMananger}},focusWindow:{get:function(){var e=this.windows,t=this.windowsSortOrder;if("z-order"==t)return e[0];if("reverse-z-order"==t)return e[e.length-1];for(var i in e)if(e[i].focused)return e[i]}},delegate:{value:null},nextTarget:{get:function(){return this.delegate}},openWindow:{value:function(e,t,i){var n,r,s=this,a=new MontageWindow,o={location:!1,menubar:!1,resizable:!0,scrollbars:!0,status:!1,titlebar:!0,toolbar:!1},l={module:e,name:t,parent:window,callback:function(e,t){var i;n=e.document.application,a.window=e,a.application=n,a.component=t,n.window=a,s.attachedWindows.push(a),i=s.mainApplication.windowsSortOrder,"z-order"==i||"reverse-open-order"==i?s.windows.unshift(a):s.windows.push(a),r=document.createEvent("CustomEvent"),r.initCustomEvent("load",!0,!0,null),a.dispatchEvent(r)}};if(this!==this.mainApplication||this._multipleWindow||this.window,"object"==typeof i){var u,h,c="",d="";for(u in i)i.hasOwnProperty(u)&&(o[u]=i[u])}var m=["name"];for(u in o)-1==m.indexOf(u)&&(h=o[u],"boolean"==typeof h?h=h?"yes":"no":(h+="",h.match(/[ ,"]/)&&(h='"'+h.replace(/"/g,'\\"')+'"')),d+=c+u+"="+h,c=",");return window.require.loadPackage({name:"montage"}).then(function(e){var t=window.open(e.location+"window-loader/index.html","_blank",d);t.loadInfo=l}).done(),a}},attachWindow:{value:function(e){var t,i=e.application.parentApplication;return i!==this&&(i&&i.detachWindow(e),e.parentApplication=this,this.attachedWindows.push(e),t=this.mainApplication.windowsSortOrder,"z-order"==t||"reverse-open-order"==t?this.windows.unshift(e):this.windows.push(e),e.focus()),e}},detachWindow:{value:function(e){var t,i,n=this.windows;return void 0===e&&(e=this.window),i=e.application.parentApplication,i==this?(t=this.attachedWindows.indexOf(e),-1!==t&&this.attachedWindows.splice(t,1),t=n.indexOf(e),-1!==t&&n.splice(t,1),e.application.parentApplication=null):i&&i.detachWindow(e),e}},constructor:{value:function(){window.loadInfo&&!this.parentApplication&&(this.parentApplication=window.loadInfo.parent.document.application)}},_load:{value:function(e,t){var i,n=this;exports.application=n,require.async("ui/component").then(function(r){return i=r.__root__,i.element=document,require("core/template").instantiateDocument(window.document,e).then(function(){n.callDelegateMethod("willFinishLoading",n),i.needsDraw=!0,t&&t(n)})}).done()}},_alertPopup:{value:null,enumerable:!1},_confirmPopup:{value:null,enumerable:!1},_notifyPopup:{value:null,enumerable:!1},_zIndex:{value:null},_isSystemPopup:{value:function(e){return"alert"===e||"confirm"===e||"notify"===e}},_createPopupSlot:{value:function(e){var t=document.createElement("div");document.body.appendChild(t),t.style.zIndex=e,t.style.position="absolute";var i=new Slot;return i.element=t,i.attachToParentComponent(),i}},getPopupSlot:{value:function(e,t,i){var n=this;require.async("ui/slot.reel/slot").then(function(r){Slot=Slot||r.Slot,e=e||"custom";var s,a,o=n._isSystemPopup(e);if(n.popupSlots=n.popupSlots||{},o)switch(e){case"alert":s=9004;break;case"confirm":s=9003;break;case"notify":s=9002}else n._zIndex=n._zIndex?n._zIndex+1:7e3,s=n._zIndex;a=n.popupSlots[e],a||(a=n.popupSlots[e]=n._createPopupSlot(s)),o||(a.element.style.zIndex=s),a.content=t,i.call(this,a)}).done()}},returnPopupSlot:{value:function(e){var t=this;if(t.popupSlots&&t.popupSlots[e]){var i=t.popupSlots[e];i.content=null}}},_getActivePopupSlots:{value:function(){var e=[];if(this.popupSlots){var t=Object.keys(this.popupSlots);if(t&&t.length>0){var i,n=0,r=t.length;for(n=0;r>n;n++)i=this.popupSlots[t[n]],i&&null!==i.content&&e.push(i)}}return e}}});